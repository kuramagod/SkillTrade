{% extends 'main/base.html' %}


{% block title %}
Chat
{% endblock %}


{% block content %}
<div class="profile-container">
    <div class="profile-posts">
        <h1>Chat Room</h1>
        <div id="chat-log">
            {% for message in messages %}
                <p><strong>{{ message.sender.username }}:</strong> {{ message.content }}</p>
            {% endfor %}
        </div>
        <textarea id="message-content" name="content" rows="4" cols="50"></textarea>
        <button id="send-button">Send</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Создаем подключение WebSocket
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/{{ chat.id }}/'
    );

    // Обработчик получения сообщений
    chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    console.log(data); // <- добавь это!
    const chatLog = document.querySelector('#chat-log');
    chatLog.innerHTML += `<p><strong>${data.username}:</strong> ${data.message}</p>`;
    };

    // Обработчик ошибок
    chatSocket.onerror = function(e) {
        console.error('WebSocket Error:', e);
    };

    // Отправка сообщений через WebSocket
    document.getElementById('send-button').onclick = function() {
        const messageContent = document.getElementById('message-content').value;
        if (messageContent.trim() !== '') {
            chatSocket.send(JSON.stringify({
                'message': messageContent
            }));
            document.getElementById('message-content').value = ''; // Очистить поле ввода
        }
    };
</script>
{% endblock %}
