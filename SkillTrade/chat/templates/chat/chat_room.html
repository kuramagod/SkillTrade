{% extends 'main/base.html' %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block title %}
Chat
{% endblock %}


{% block content %}
<div class="flex justify-center px-4 mt-12">
  <div class="w-full max-w-2xl bg-white shadow-lg rounded-2xl overflow-hidden flex flex-col h-[80vh]">
    <!-- Заголовок -->
    <div class="bg-blue-600 text-white px-6 py-4 text-xl font-semibold">
      Комната чата
    </div>

    <!-- Область сообщений -->
    <div id="chat-log" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 text-sm">
      {% for message in messages %}
        {% if message.sender == user %}
          <!-- Моё сообщение (справа) -->
          <div class="flex justify-end space-x-2" data-message-id="{{ message.id }}">
            <div class="bg-blue-100 text-gray-800 px-4 py-2 rounded-xl max-w-[70%]">
              <p class="text-sm font-medium">{{ message.content }}</p>
            </div>
            <img src="{{ user.avatar.url|default:default_image }}" class="w-8 h-8 rounded-full object-cover">
          </div>
        {% else %}
          <!-- Сообщение другого пользователя (слева) -->
          <div class="flex justify-start space-x-2" data-message-id="{{ message.id }}">
            <img src="{{ message.sender.avatar.url|default:default_image }}" class="w-8 h-8 rounded-full object-cover">
            <div class="bg-gray-100 text-gray-800 px-4 py-2 rounded-xl max-w-[70%]">
              <p class="text-sm font-medium">{{ message.content }}</p>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Ввод -->
    <div class="border-t px-6 py-4 bg-gray-50 flex items-center space-x-4">
      <textarea id="message-content"
                rows="1"
                class="flex-1 resize-none border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Напишите сообщение..."></textarea>
      <button id="send-button"
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition">
        Отправить
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const chatSocket = new WebSocket(
      'ws://' + window.location.host + '/ws/chat/{{ chat.id }}/'
  );

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const chatLog = document.querySelector('#chat-log');

      const isMine = data.username === "{{ user.username }}";

      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'items-end', 'space-x-2', 'mt-2');
      if (isMine) {
          wrapper.classList.add('justify-end');
      } else {
          wrapper.classList.add('justify-start');
      }

      wrapper.innerHTML = isMine
          ? `
            <div class="bg-blue-100 text-gray-800 px-4 py-2 rounded-xl max-w-[70%]">
              <p class="text-sm font-medium">${data.message}</p>
            </div>
            <img src="${data.avatar_url}" class="w-8 h-8 rounded-full object-cover">
          `
          : `
            <img src="${data.avatar_url}" class="w-8 h-8 rounded-full object-cover">
            <div class="bg-gray-100 text-gray-800 px-4 py-2 rounded-xl max-w-[70%]">
              <p class="text-sm font-medium">${data.message}</p>
            </div>
          `;

      chatLog.appendChild(wrapper);
      chatLog.scrollTop = chatLog.scrollHeight;
  };

  document.getElementById('send-button').onclick = function() {
      const textarea = document.getElementById('message-content');
      const messageContent = textarea.value.trim();

      if (messageContent !== '') {
          chatSocket.send(JSON.stringify({
              'message': messageContent
          }));
          textarea.value = '';
      }
  };
</script>
{% endblock %}