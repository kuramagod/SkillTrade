{% extends 'main/base.html' %}

{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static 'main/css/base.css' %}">
{% endblock %}

{% block title %}
MainPage
{% endblock %}

{% block content %}
<main>
    <div class="main-container">
        <aside class="categories">
            <h3>Навыки</h3>
            <ul>
                <h4>Предлагаемые</h4>
                {% for skill in offered_skills %}
                <li>
                    <label>
                        <input type="radio" name="skill" value="{{ skill.slug }}" class="skill-radio"
                            {% if request.GET.skill == skill.slug %}checked{% endif %}>
                        <span>{{ skill.name }}</span>
                    </label>
                </li>
                {% endfor %}
                <h4>Запрашиваемые</h4>
                {% for skill in wanted_skills %}
                <li>
                    <label>
                        <input type="radio" name="skill" value="{{ skill.slug }}" class="skill-radio"
                            {% if request.GET.skill == skill.slug %}checked{% endif %}>
                        <span>{{ skill.name }}</span>
                    </label>
                </li>
                {% endfor %}
            </ul>
        </aside>
        <section class="posts">
            {% for post in posts %}
            <article class="post">
                <div class="user-info">
                    <a class="username-a" href="{{ post.author.get_absolute_url }}">
                        <img src="{{ post.author.avatar.url|default:default_image }}" alt="Аватар">
                        <p class="username">{{ post.author.username }}</p>
                    </a>
                </div>
                <div class="post-content">
                    <p>Предлогает: {{ post.offered_skill.skill }}. Запрашивает: {{ post.wanted_skill.name }}</p>
                    {% if user.is_authenticated %}
                    <form class="exchange-request-form" method="post" action="{% url 'create_request' post.id %}">
                        {% csrf_token %}
                        <button class="read-more exchange-request-btn" type="submit">Кинуть заявку</button>
                    </form>
                    {% else %}
                    <a href="{% url 'users:login' %}">
                        <button class="read-more exchange-request-btn" type="submit">Кинуть заявку</button>
                    </a>
                    {% endif %}

                    <span class="message-container" style="display: none; color: green;">Отправлено</span>
                </div>
            </article>
            {% endfor %}
        </section>
    </div>
    </section>
</main>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.exchange-request-form').forEach(form => {
            form.addEventListener('submit', function (event) {
                event.preventDefault(); // Отменяем стандартную отправку формы

                const form = event.target;
                const postId = form.getAttribute('action').split('/').pop(); // Получаем ID поста из URL
                const messageContainer = form.nextElementSibling; // Блок "Отправлено"
                const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Показываем сообщение "Отправлено" и скрываем кнопку
                        messageContainer.style.display = 'inline';
                        form.style.display = 'none';
                    } else {
                        alert('Ошибка: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
            });
        });
    });
    document.querySelectorAll('.skill-radio').forEach(radio => {
        radio.addEventListener('change', function () {
            const params = new URLSearchParams(window.location.search);
            params.set('skill', this.value);
            window.location.search = params.toString();
        });
    });

</script>
{% endblock %}